<div class="table-container">
  <shared-feedback-message />
  @if (isSelectionMode()) {
  <div class="alert alert-info mb-3">
    <shared-icon type="info" />
    <div>
      <h3 class="font-bold">Select Person to Link</h3>
      <div class="text-xs">
        Click "Link Person" to link a person to the user, or "Change Link" to switch an existing link.
      </div>
    </div>
  </div>
  }

  <!-- Search and Controls Row -->
  <div class="flex flex-col lg:flex-row gap-4 mb-4">
    <!-- Search Bar - Takes most space -->
    <div class="flex-1">
      <shared-search-bar
        placeholder="Search persons by name, email, ID number..."
        (searchChange)="handleSearch($event)"
      />
    </div>

    <!-- Controls Group - Compact and aligned -->
    <div class="flex items-center gap-3 flex-wrap">
      <!-- Filter Group -->
      <div class="flex items-center gap-2">
        <span class="text-xs font-medium text-base-content/60">Show:</span>
        <div class="flex gap-1">
          <!-- All Persons -->
          <button
            class="btn btn-xs"
            [class.btn-primary]="!hasActiveFilters()"
            [class.btn-ghost]="hasActiveFilters()"
            (click)="clearAllFilters()"
            title="Show all persons"
          >
            <shared-icon
              type="users"
              size="xs"
            />
            <span class="hidden sm:inline">All</span>
          </button>

          <!-- Employees Only -->
          <button
            class="btn btn-xs"
            [class.btn-success]="showOnlyEmployees() && !showOnlyUsers()"
            [class.btn-ghost]="!showOnlyEmployees() || showOnlyUsers()"
            (click)="toggleEmployeeFilter()"
            title="Show employees only"
          >
            <shared-icon
              type="user-tie"
              size="xs"
            />
            <span class="hidden sm:inline">Employees</span>
          </button>

          <!-- Users Only -->
          <button
            class="btn btn-xs"
            [class.btn-info]="showOnlyUsers() && !showOnlyEmployees()"
            [class.btn-ghost]="!showOnlyUsers() || showOnlyEmployees()"
            (click)="toggleUserFilter()"
            title="Show users only"
          >
            <shared-icon
              type="user-check"
              size="xs"
            />
            <span class="hidden sm:inline">Users</span>
          </button>

          <!-- Complete Profiles -->
          <button
            class="btn btn-xs"
            [class.btn-primary]="showOnlyEmployees() && showOnlyUsers()"
            [class.btn-ghost]="!showOnlyEmployees() || !showOnlyUsers()"
            (click)="showCompleteProfiles()"
            title="Show complete profiles (Employee + User)"
          >
            <shared-icon
              type="user-astronaut"
              size="xs"
            />
            <span class="hidden sm:inline">Complete</span>
          </button>
        </div>
      </div>

      <!-- Filter Status Badge -->
      @if (hasActiveFilters()) {
      <div class="badge badge-info badge-sm">
        {{ filteredCount() }}/{{ totalPersons() }}
      </div>
      }

      <!-- Simple Separator -->
      <div class="w-px h-4 bg-base-300"></div>

      <!-- Display Preferences -->
      <div class="flex items-center gap-2">
        <span class="text-xs font-medium text-base-content/60">Display:</span>
        <button
          class="btn btn-xs"
          [class.btn-secondary]="showLastNameFirst()"
          [class.btn-ghost]="!showLastNameFirst()"
          (click)="toggleNameOrder()"
          [title]="showLastNameFirst() ? 'Currently: Last + First' : 'Currently: First + Last'"
        >
          {{ showLastNameFirst() ? 'L+F' : 'F+L' }}
        </button>
      </div>
    </div>
  </div>

  <div class="table-wrapper">
    <div class="table-scroll">
      <table class="table table-zebra w-full">
        <thead>
          <tr class="table-header-row">
            @for (column of columns; track column.key) {
            <th
              [class.table-header-cell-sortable]="column.sortable"
              (click)="handleSort(column.key)"
              class="table-header-cell"
            >
              <div class="flex items-center gap-2">
                <span
                  [class]="getSortClass(column.key)"
                  class="table-header-text"
                >
                  {{ column.label }}
                </span>
                @if (column.sortable) {
                <shared-icon
                  [type]="getSortIcon(column.key)"
                  size="xs"
                />
                }
              </div>
            </th>
            }
          </tr>
        </thead>
        <tbody>
          @for (person of filteredPersons(); track person.id; let i = $index) {
          <tr class="table-body-row">
            <td class="table-cell">
              <div class="flex items-center gap-3">
                <div>
                  <a
                    [routerLink]="['/admin/persons', person.id]"
                    class="table-link"
                  >
                    {{ getFullName(person) }}
                  </a>
                </div>
              </div>
            </td>
            <td class="table-cell">{{ getIdentificationTypeCode(person.identType) }} - {{ person.identNumber }}</td>
            <td class="table-cell">{{ person.email }}</td>
            <td class="table-cell">{{ person.mobile }}</td>
            <td class="table-cell">{{ person.city }}</td>
            <td class="table-cell">
              <div class="flex justify-center">
                <shared-icon
                  [type]="getTypeIcon(person)"
                  [class]="getTypeCssClass(person)"
                  size="lg"
                  [title]="getTypeTooltip(person)"
                />
              </div>
            </td>
            <td class="table-cell">
              <span
                class="status-badge"
                [class]="person.isActive ? 'status-badge-success' : 'status-badge-error'"
              >
                {{ person.isActive ? 'Active' : 'Inactive' }}
              </span>
            </td>
            <td class="table-cell">
              @if (isSelectionMode()) {
              <div class="flex flex-col gap-1.5">
                @if (person.userId) {
                <button
                  class="action-button action-button-warning"
                  (click)="linkPersonWithUser(person)"
                >
                  <shared-icon type="sync" />
                  Change Link
                </button>
                } @else {
                <button
                  class="action-button action-button-primary"
                  (click)="linkPersonWithUser(person)"
                >
                  <shared-icon type="add" />
                  Link Person
                </button>
                }
              </div>
              } @else {
              <a
                [routerLink]="['/admin/persons', person.id]"
                class="action-button action-button-info"
              >
                <shared-icon type="ellipsis-vertical" />
              </a>
              }
            </td>
          </tr>
          }
        </tbody>
      </table>
    </div>
  </div>

  @if(personsResource.isLoading()) {
  <shared-loading />
  }

  @if(personsResource.error()) {
  <div class="error-container">
    <shared-icon type="error" />
    <span>Error: {{ personsResource.error()?.message }}</span>
  </div>
  }

  <shared-pagination
    [totalPages]="personsResource.value()?.pagination?.totalPages ?? 0"
    [totalItems]="filteredPersons().length"
    [itemsPerPage]="personsPerPage()"
  />
</div>
