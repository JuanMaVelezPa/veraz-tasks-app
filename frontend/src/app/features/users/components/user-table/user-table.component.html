<div class="table-container">
  @if (isSelectionMode()) {
  <div class="bg-info/10 border border-info/20 rounded-lg p-4 mb-4">
    <div class="flex items-center gap-3">
      <shared-icon type="info" class="text-info" />
      <div>
        <h3 class="font-semibold text-info">Select User for {{ selectedPersonName() }}</h3>
        <p class="text-xs text-info/70">
          <shared-icon type="filter" size="xs" />
          Available users only
        </p>
      </div>
      <button
        class="btn btn-outline btn-sm ml-auto"
        (click)="goBack()"
      >
        <shared-icon type="back" />
        Cancel
      </button>
    </div>
  </div>
  }

  <div class="search-layout">
    <div class="search-bar-container">
      <shared-search-bar
        placeholder="Search users by username, email..."
        (searchChange)="handleSearch($event)"
      />
    </div>
  </div>

  <div class="table-wrapper">
    <div class="table-scroll">
      <table class="table table-zebra w-full">
        <thead>
          <tr class="table-header-row">
            @for (column of columns; track column.key) {
            <th
              [class.table-header-cell-sortable]="column.sortable"
              (click)="handleSort(column.key)"
              class="table-header-cell"
            >
              <div class="flex items-center gap-2">
                <span
                  [class]="getSortClass(column.key)"
                  class="table-header-text"
                >
                  {{ column.label }}
                </span>
                @if (column.sortable) {
                <shared-icon
                  [type]="getSortIcon(column.key)"
                  size="xs"
                />
                }
              </div>
            </th>
            }
          </tr>
        </thead>
        <tbody>
          @for (user of usersResource.value()?.data ?? []; track user.id; let i = $index) {
          <tr class="table-body-row">
            <td class="table-cell">
              <div class="flex items-center gap-3">
                <div>
                  <a
                    [routerLink]="['/admin/users', user.id]"
                    class="table-link"
                  >
                    {{ user.username }}
                  </a>
                </div>
              </div>
            </td>
            <td class="table-cell">{{ user.email }}</td>
            <td class="table-cell">
              @for (role of user.roles; track role) {
              <span class="role-badge">{{ role }}</span>
              }
            </td>
            <td class="table-cell">{{ user.createdAt | date:'dd/MM/yyyy' }}</td>
            <td class="table-cell">
              <span
                class="status-badge"
                [class]="user.isActive ? 'status-badge-success' : 'status-badge-error'"
              >
                <shared-icon type="check" />
                {{ user.isActive ? 'Active' : 'Inactive' }}
              </span>
            </td>
            <td class="table-cell">
              @if (isSelectionMode()) {
              <button
                class="action-button action-button-primary"
                (click)="associateUser(user.id)"
                title="Associate with person"
              >
                <shared-icon type="user-plus" />
              </button>
              } @else {
              <a
                [routerLink]="['/admin/users', user.id]"
                class="action-button action-button-info"
              >
                <shared-icon type="ellipsis-vertical" />
              </a>
              }
            </td>
          </tr>
          }
        </tbody>
      </table>
    </div>
  </div>

  @if(usersResource.isLoading()) {
  <div class="loading-container">
    <shared-loading></shared-loading>
  </div>
  }

  @if(usersResource.error()) {
  <div class="error-container">
    <shared-icon type="error" />
    <span>Error: {{ usersResource.error()?.message }}</span>
  </div>
  }

  <shared-pagination
    [totalPages]="usersResource.value()?.pagination?.totalPages ?? 0"
    [totalItems]="usersResource.value()?.pagination?.totalElements ?? 0"
    [itemsPerPage]="usersPerPage()"
  />
</div>
