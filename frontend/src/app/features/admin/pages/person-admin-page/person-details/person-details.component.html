<div class="bg-base-200 w-full">

  <div class="max-w-6xl mx-auto w-full">
    <div class="flex flex-col sm:flex-row justify-between items-center gap-4 mb-6">
      <div class="w-full sm:w-auto text-center sm:text-left">
        <h1 class="text-xl sm:text-2xl font-bold">{{ isEditMode() ? 'Edit' : 'Create' }} Person</h1>
        <p class="text-sm text-gray-500">Person management information</p>

      </div>

      <shared-feedback-message />

      <div class="flex flex-wrap gap-2 justify-center sm:justify-end">
        <button
          class="btn btn-outline btn-xs sm:btn-sm"
          (click)="goBack()"
          title="Back"
        >
          <shared-icon type="back" />
        </button>

        @if (isEditMode()) {
        <button
          class="btn btn-error btn-xs sm:btn-sm"
          (click)="showDeleteConfirmation()"
          [disabled]="isLoading()"
        >
          <shared-icon type="delete" />
        </button>
        }
      </div>
    </div>

    <shared-tabs
      [tabs]="tabs()"
      [activeTab]="activeTab()"
      (activeTabChange)="setActiveTab($event)"
    />

    @if (activeTab() === 'person') {
    <app-personal-info-tab
      [personForm]="personForm"
      [person]="person()"
      [isEditMode]="isEditMode()"
      [isLoading]="isLoading()"
      (formSubmitted)="submitForm()"
    />
    }

    @if (activeTab() === 'employee') {
    <app-employee-tab
      [employeeForm]="employeeForm"
      [employee]="currentEmployee()"
      [isEditMode]="isEditMode()"
      [isLoading]="isLoading()"
      [isLoadingEmployee]="isLoadingEmployee()"
      (formSubmitted)="submitEmployeeForm()"
    />
    }

    @if (activeTab() === 'user') {
    <app-user-tab
      [currentUser]="currentUser()"
      [isEditMode]="isEditMode()"
      [isLoadingUser]="isLoadingUser()"
      [userForm]="userForm"
      [isReadOnly]="false"
      (editUser)="editUser()"
      (removeUserAssociation)="removeUserAssociation()"
      (linkExistingUser)="linkExistingUser()"
      (createNewUser)="createNewUser()"
      (formSubmitted)="onUserFormSubmitted()"
    />
    }

    @if (isEditMode()) {
    <div class="card bg-base-100 shadow-lg">
      <div class="card-body p-4 sm:p-6">
        @if (activeTab() === 'person' && person()) {
        <shared-timestamp-info
          [entity]="person()"
          title="Personal Information"
        />
        }
        @if (activeTab() === 'employee' && currentEmployee()) {
        <shared-timestamp-info
          [entity]="currentEmployee()"
          title="Employment Information"
        />
        }
        @if (activeTab() === 'employee' && !currentEmployee()) {
        <div class="bg-base-100 rounded-lg border border-base-300 p-4 shadow-sm">
          <div class="flex items-center gap-3">
            <div class="w-8 h-8 bg-warning/10 rounded-full flex items-center justify-center">
              <shared-icon
                type="warning"
                size="sm"
                class="text-warning"
              />
            </div>
            <div>
              <h3 class="font-semibold text-base-content">Employment Information</h3>
              <p class="text-sm text-base-content/60">No employment information available</p>
            </div>
          </div>
        </div>
        }
        @if (activeTab() === 'user' && currentUser()) {
        <shared-timestamp-info
          [entity]="currentUser()"
          title="User Account"
        />
        }
        @if (activeTab() === 'user' && !currentUser()) {
        <div class="bg-base-100 rounded-lg border border-base-300 p-4 shadow-sm">
          <div class="flex items-center gap-3">
            <div class="w-8 h-8 bg-warning/10 rounded-full flex items-center justify-center">
              <shared-icon
                type="warning"
                size="sm"
                class="text-warning"
              />
            </div>
            <div>
              <h3 class="font-semibold text-base-content">User Account</h3>
              <p class="text-sm text-base-content/60">No user account associated</p>
            </div>
          </div>
        </div>
        }
      </div>
    </div>
    }

  </div>

  @if (showDeleteModal()) {
  <dialog class="modal modal-open">
    <div class="modal-box">
      <h3 class="font-bold text-lg text-error">Delete Person</h3>
      <p class="py-4">
        Delete <strong>{{ currentPerson()?.firstName }} {{ currentPerson()?.lastName }}</strong>?
      </p>
      <p class="text-sm text-gray-500 mb-4">
        This action cannot be undone.
      </p>
      <div class="bg-secondary/10 border border-secondary/20 rounded-lg p-4 mb-4">
        <div class="flex items-center gap-3">
          <shared-icon
            type="info"
            class="text-secondary"
          />
          <div>
            <p class="text-sm text-secondary/80">
              <strong>Person and employment data will be deleted.</strong>
              @if (currentUser()) {
              User account will be preserved but disassociated.
              }
            </p>
          </div>
        </div>
      </div>
      <div class="modal-action">
        <button
          class="btn btn-outline"
          (click)="cancelDelete()"
          [disabled]="isLoading()"
        >
          Cancel
        </button>
        <button
          class="btn btn-error"
          (click)="deletePerson()"
          [disabled]="isLoading()"
        >
          @if (isLoading()) {
          <shared-loading></shared-loading>
          } @else {
          <shared-icon type="delete" />
          }
          Delete Person
        </button>
      </div>
    </div>
    <form
      method="dialog"
      class="modal-backdrop"
    >
      <button (click)="cancelDelete()">close</button>
    </form>
  </dialog>
  }
</div>
